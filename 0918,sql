-- Group by: 여러 데이터에서 의미 있는 하나의 결과를 특정 열 값으로 묶어서 출력
-- 전체 평균
SELECT ROUND(AVG(SAL), 2) 
FROM EMP;

-- 부서별 평균
SELECT DEPTNO, ROUND(AVG(SAL), 2)
FROM EMP
GROUP BY DEPTNO
ORDER BY DEPTNO;

-- GROUP BY 절 없이 구현한다면?
SELECT ROUND(AVG(SAL), 2) FROM EMP WHERE DEPTNO = 10;
SELECT ROUND(AVG(SAL), 2) FROM EMP WHERE DEPTNO = 20;
SELECT ROUND(AVG(SAL), 2) FROM EMP WHERE DEPTNO = 30;

-- 집합 연산자를 사용하여 구현
SELECT AVG(SAL)FROM EMP WHERE DEPTNO = 10
UNION ALL
SELECT AVG(SAL)FROM EMP WHERE DEPTNO = 20
UNION ALL
SELECT AVG(SAL)FROM EMP WHERE DEPTNO = 30;

-- 부서코드, 급여합계, 부서 평균, 부서 코드 순 정렬
SELECT DEPTNO 부서코드, SUM(SAL) 합계, ROUND(AVG(SAL)) 평균, COUNT(*) 총인원
FROM EMP
GROUP BY DEPTNO
ORDER BY DEPTNO ASC;

-- HAVING 절: GROUP BY 절이 존재할 떄만 사용 가능
-- GROUP BY 절을 통해 그룹화된 결과 값의 번위를 제한할 때 사용
-- 먼저 부서별, 직책별 그룹화하여 평균을 구함
-- 그다음에 각 그룹의 급여 평균이 2000이 넘는 결과 출력
SELECT DEPTNO, JOB, ROUND(AVG(SAL),2)
FROM EMP
GROUP BY DEPTNO, JOB    -- 부서별로 묶고 거기에 직업으로 한번더 나눔
HAVING AVG(SAL) >= 2000     -- 평균은 2000이상의 급여로 
ORDER BY DEPTNO, JOB;

-- WHERE
-- 먼저 급여가 2000이 넘는 사원들을 구분
-- 조건에 맞는 사원중에서 부서별, 직책별 급여의 평균을 구해서 출력
SELECT DEPTNO, JOB, ROUND(AVG(SAL),2)
FROM EMP
WHERE AVG(SAL) >= 2000
GROUP BY DEPTNO, JOB    -- 부서별로 묶고 거기에 직업으로 한번더 나눔
ORDER BY DEPTNO, JOB;



-- 예제: 
-- 1. 부서별 직책의 평균 급여가 500이상인 사원들의 부서 번호, 직책, 부서별 직책의 평균 급여
SELECT DEPTNO, JOB, ROUND(AVG(SAL),2)
FROM EMP
GROUP BY DEPTNO, JOB
HAVING ROUND(AVG(SAL),2) >= 500;
-- 2. EMP 테이블을 이용하여 부서번호, 평균급여, 최고급여, 최저급여, 사원수를 출력,
--   단, 평균 급여를 출력 할 때는 소수점 제외하고 부서 번호별로 출력
SELECT DEPTNO, TRUNC(AVG(SAL)), MAX(SAL), MIN(SAL), COUNT(*)
FROM EMP
GROUP BY DEPTNO
ORDER BY DEPTNO;
-- 3. 같은 직책에 종사하는 사원이 3명 이상인 직책과 인원을 출력
SELECT JOB, COUNT(*)
FROM EMP
GROUP BY JOB
HAVING COUNT(JOB) >= 3;
-- 4. 사원들의 입사 연도를 기준으로 부서별로 몇 명이 입사했는지 출력
SELECT TO_CHAR(HIREDATE, 'YYYY'), DEPTNO, COUNT(*)
-- EXTRACT(YEAR FROM HIREDATE)
FROM EMP
GROUP BY TO_CHAR(HIREDATE, 'YYYY'), DEPTNO;

-- 5. 추가 수당을 받는 사원 수와 받지 않는 사원수를 출력 (O, X로 표기 필요)
SELECT NVL2(COMM, 'O', 'X'), COUNT(*)
FROM EMP
GROUP BY NVL2(COMM, 'O', 'X');

-- 6. 각 부서의 입사 연도별 사원 수, 최고 급여, 급여 합, 평균 급여를 출력
SELECT DEPTNO, TO_CHAR(HIREDATE, 'YYYY'), MAX(SAL), SUM(SAL), ROUND(AVG(SAL), 2), COUNT(*)
FROM EMP
GROUP BY DEPTNO, TO_CHAR(HIREDATE, 'YYYY')
ORDER BY DEPTNO, TO_CHAR(HIREDATE, 'YYYY');

-- 그룹화와 관련된 여러 함수: ROLLUP, CUBE..

-- ### ROLLUP 함수를 적용한 그룹화
-- **명시한 열을 소그룹부터 대그룹의 순서로 각 그룹별 결과를 출력하고 
-- 마지막에 총 데이터 결과를 출력** 합니다.
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), ROUND(AVG(SAL))
FROM EMP
GROUP BY ROLLUP(DEPTNO, JOB);
